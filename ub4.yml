- hosts: ub4
  become: true
  pre_tasks:
    - name: Include local_vars
      include_vars:
        file: local_vars.yml
    - name: Bind-mount rtorrent var directory
      file:
        state: link
        src: /mnt/data/dl
        path: "{{ rtorrent_var_dir }}"
  roles:
    - role: common
      tags: [ common ]
    - docker
    - role: torrent
      vars:
        torrent_home: /mnt/data/home/torrent
        domain_name: "rutorrent.{{ top_domain_name }}"
        https_certificate_path: "/etc/ssl_certificates/rutorrent.{{ top_domain_name }}/fullchain.pem"
        https_key_path: "/etc/ssl_certificates/rutorrent.{{ top_domain_name }}/privatekey.pem"
      tags: [ torrent ]
    - role: web
      tags: [ web ]
    - role: ipfs
      vars:
        ipfs_autonat_service_mode: disabled
        ipfs_filestore_enabled: "true"
      tags: [ ipfs ]
    - name: rsshub
      vars:
        domain_name: "rsshub.{{ top_domain_name }}"
        https_certificate_path: "/etc/ssl_certificates/rsshub.{{ top_domain_name }}/fullchain.pem"
        https_key_path: "/etc/ssl_certificates/rsshub.{{ top_domain_name }}/privatekey.pem"
      tags: rsshub
    - role: nas
      tags: [ nas ]
      vars:
        shared_paths: "{{ nfs_shared_paths }}"
    - role: borg_backup_target
      tags: [ borg_backup_target ]
    - role: tor
      tags: [ tor ]
    - role: netdata
      vars:
        domain_name: "netdata.ub4.{{ top_domain_name }}"
        https_certificate_path: "/etc/ssl_certificates/netdata.ub4.{{ top_domain_name }}/fullchain.pem"
        https_key_path: "/etc/ssl_certificates/netdata.ub4.{{ top_domain_name }}/privatekey.pem"
      tags: [ netdata ]
    - role: https
      vars:
        https_domains:
          - "rutorrent.{{ top_domain_name }}"
          - "rsshub.{{ top_domain_name }}"
          - "netdata.ub4.{{ top_domain_name }}"
      tags: https
  tasks:
    - name: Add authorized_keys to root
      authorized_key:
        key: "{{ item }}"
        user: root
      with_file:
        - authorized_keys/gileri_ryz
        - authorized_keys/gileri_tpy

    - name: Install stress tui
      pacman:
        name: s-tui

    - name: Add pierre user
      user:
        name: pierre
        groups:
          - pierre
          - torrent

    - name: Add authorized_keys to pierre
      authorized_key:
        key: "{{ lookup('file', 'authorized_keys/pierre') }}"
        user: pierre
    - name: Bind mount NAS folder to IPFS home directory
      file:
        state: link
        src: /mnt/data
        path: "{{ ipfs_home }}/data"
